version: "3.9"

services:
  api-mongo:
    image: ghcr.io/hallboard-team/dotnet:${DOTNET_VERSION:-10.0}-sdk
    container_name: ${COMPOSE_PROJECT_NAME:-template_backend_mongo}-api-dev
    user: "0:0"
    working_dir: /workspaces/app

    volumes:
      - ../../:/workspaces/app:Z
      - ${HOME}/.cache/vscode-server-shared:/home/vscode/.vscode-server-shared:Z
      - ${HOME}/.cache/codex:/home/vscode/.codex:Z

    env_file:
      - ./.env

    environment:
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_URLS: http://0.0.0.0:5000
      VSCODE_SERVER_DIR: /home/vscode/.vscode-server-shared
      CODEX_HOME: /home/vscode/.codex

      MONGO_HOST: "mongo"
      DB_USER: "${DB_USER:-mongo_user}"
      DB_PASSWORD: "${DB_PASSWORD:-mongo_password}"
      MongoDb__ConnectionString: "mongodb://${DB_USER:-mongo_user}:${DB_PASSWORD:-mongo_password}@mongo:27017/${COMPOSE_PROJECT_NAME:-template_backend_mongo}?authSource=admin&retryWrites=true&replicaSet=rs0"
      MongoDb__DatabaseName: "${COMPOSE_PROJECT_NAME:-template_backend_mongo}"

    ports:
      - "${API_PORT:-5002}:5000"

    command: >
      bash -c "
        dotnet --info &&
        sleep infinity
      "

    networks:
      - shared-mongo-net

networks:
  shared-mongo-net:
    external: true
    name: ${MONGO_NETWORK_NAME:-shared-mongo-net}
